<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="es" xml:lang="es"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.25">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<meta name="author" content="Hadley Wickham, Danielle Navarro, y Thomas Lin Pedersen">
<title>19&nbsp; Internos de ggplot2 – ggplot2: Gráficos elegantes para análisis de datos (3e)</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>

<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./extensions.html" rel="next">
<link href="./programming.html" rel="prev">
<link href="./cover.jpg" rel="icon" type="image/jpeg">
<script src="site_libs/quarto-html/quarto.js" type="module"></script>
<script src="site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-7b89279ff1a6dce999919e0e67d4d9ec.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-0dd2bd5de344125cf763a379ddc3eb04.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light"><script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No se han encontrado resultados",
    "search-matching-documents-text": "documentos encontrados",
    "search-copy-link-title": "Copiar el enlace en la búsqueda",
    "search-hide-matches-text": "Ocultar resultados adicionales",
    "search-more-match-text": "resultado adicional en este documento",
    "search-more-matches-text": "resultados adicionales en este documento",
    "search-clear-button-title": "Borrar",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancelar",
    "search-submit-button-title": "Enviar",
    "search-label": "Buscar"
  }
}</script><meta name="google-site-verification" content="kphyQu6n4JhBUuoLZxnJpD9dbw9q5FLwqXb9AkI2fhU">
</head>
<body class="nav-sidebar floating quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top"><nav class="quarto-secondary-nav"><div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Alternar barra lateral" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./extending.html">Temas avanzados</a></li><li class="breadcrumb-item"><a href="./internals.html"><span class="chapter-number">19</span>&nbsp; <span class="chapter-title">Internos de ggplot2</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Alternar barra lateral" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Buscar" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav></header><!-- content --><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto"><div class="pt-lg-2 mt-2 text-left sidebar-header sidebar-header-stacked">
      <a href="./index.html" class="sidebar-logo-link">
      </a>
    <div class="sidebar-title mb-0 py-0">
      <a href="./">ggplot2: Gráficos elegantes para análisis de datos (3e)</a> 
        <div class="sidebar-tools-main">
    <div class="dropdown">
      <a href="" title="" id="quarto-navigation-tool-dropdown-0" class="quarto-navigation-tool dropdown-toggle px-1" data-bs-toggle="dropdown" aria-expanded="false" role="link" aria-label=""><i class="bi bi-github"></i></a>
      <ul class="dropdown-menu" aria-labelledby="quarto-navigation-tool-dropdown-0">
<li>
            <a class="dropdown-item sidebar-tools-main-item" href="https://github.com/hadley/ggplot2-book/">
            Original
            </a>
          </li>
          <li>
            <a class="dropdown-item sidebar-tools-main-item" href="https://github.com/davidrsch/ggplot2b-es">
            Traducción
            </a>
          </li>
      </ul>
</div>
  <a href="" class="quarto-reader-toggle quarto-navigation-tool px-1" onclick="window.quartoToggleReader(); return false;" title="Alternar modo lector">
  <div class="quarto-reader-toggle-btn">
  <i class="bi"></i>
  </div>
</a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Buscar"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">¡Bienvenidos!</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./preface-3e.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Prefacio a la tercera edición</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./preface-2e.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Prefacio a la segunda edición.</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="./start.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Empezando</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Alternar sección">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./introduction.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Introducción</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./getting-started.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Primeros pasos</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="./toolbox.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Layers</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true" aria-label="Alternar sección">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./individual-geoms.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Geomas individuales</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./collective-geoms.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Geomas colectivas</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./statistical-summaries.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Resúmenes estadísticos</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./maps.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Mapas</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./networks.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Redes</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./annotations.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Anotaciones</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./arranging-plots.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Organizar gráficas</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="./scales.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Scales</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true" aria-label="Alternar sección">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./scales-position.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Escalas de posición y ejes.</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./scales-colour.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Escalas de colores y leyendas.</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./scales-other.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Otra estéticas</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="./mastery.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">La Gramática</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true" aria-label="Alternar sección">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./layers.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Construya una gráfica capa por capa</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./scales-guides.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Escalas y guías</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./coord.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">Sistemas coordinados</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./facet.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">Facetado</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./themes.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">17</span>&nbsp; <span class="chapter-title">Temas</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="./extending.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Temas avanzados</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" role="navigation" aria-expanded="true" aria-label="Alternar sección">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-5" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./programming.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">18</span>&nbsp; <span class="chapter-title">Programar con ggplot2</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./internals.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">19</span>&nbsp; <span class="chapter-title">Internos de ggplot2</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./extensions.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">20</span>&nbsp; <span class="chapter-title">Extendiendo ggplot2</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./ext-springs.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">21</span>&nbsp; <span class="chapter-title">Un caso de estudio</span></span></a>
  </div>
</li>
      </ul>
</li>
    </ul>
</div>
</nav><div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active"><h2 id="toc-title">Tabla de contenidos</h2>
   
  <ul>
<li><a href="#sec-plot-method" id="toc-sec-plot-method" class="nav-link active" data-scroll-target="#sec-plot-method"><span class="header-section-number">19.1</span> El método <code>plot()</code></a></li>
  <li>
<a href="#sec-ggplotbuild" id="toc-sec-ggplotbuild" class="nav-link" data-scroll-target="#sec-ggplotbuild"><span class="header-section-number">19.2</span> El paso de construcción</a>
  <ul class="collapse">
<li><a href="#preparaci%C3%B3n-de-datos" id="toc-preparación-de-datos" class="nav-link" data-scroll-target="#preparaci%C3%B3n-de-datos"><span class="header-section-number">19.2.1</span> Preparación de datos</a></li>
  <li><a href="#transformaci%C3%B3n-de-datos" id="toc-transformación-de-datos" class="nav-link" data-scroll-target="#transformaci%C3%B3n-de-datos"><span class="header-section-number">19.2.2</span> Transformación de datos</a></li>
  <li><a href="#salida" id="toc-salida" class="nav-link" data-scroll-target="#salida"><span class="header-section-number">19.2.3</span> Salida</a></li>
  </ul>
</li>
  <li>
<a href="#sec-ggplotgtable" id="toc-sec-ggplotgtable" class="nav-link" data-scroll-target="#sec-ggplotgtable"><span class="header-section-number">19.3</span> El paso gtable</a>
  <ul class="collapse">
<li><a href="#renderizando-los-paneles" id="toc-renderizando-los-paneles" class="nav-link" data-scroll-target="#renderizando-los-paneles"><span class="header-section-number">19.3.1</span> Renderizando los paneles</a></li>
  <li><a href="#agregar-gu%C3%ADas" id="toc-agregar-guías" class="nav-link" data-scroll-target="#agregar-gu%C3%ADas"><span class="header-section-number">19.3.2</span> Agregar guías</a></li>
  <li><a href="#a%C3%B1adiendo-adorno" id="toc-añadiendo-adorno" class="nav-link" data-scroll-target="#a%C3%B1adiendo-adorno"><span class="header-section-number">19.3.3</span> Añadiendo adorno</a></li>
  <li><a href="#salida-1" id="toc-salida-1" class="nav-link" data-scroll-target="#salida-1"><span class="header-section-number">19.3.4</span> Salida</a></li>
  </ul>
</li>
  <li>
<a href="#sec-ggproto" id="toc-sec-ggproto" class="nav-link" data-scroll-target="#sec-ggproto"><span class="header-section-number">19.4</span> Presentando ggproto</a>
  <ul class="collapse">
<li><a href="#objetos-ggproto" id="toc-objetos-ggproto" class="nav-link" data-scroll-target="#objetos-ggproto"><span class="header-section-number">19.4.1</span> objetos ggproto</a></li>
  <li><a href="#creando-nuevas-clases" id="toc-creando-nuevas-clases" class="nav-link" data-scroll-target="#creando-nuevas-clases"><span class="header-section-number">19.4.2</span> Creando nuevas clases</a></li>
  <li><a href="#sec-ggproto-instances" id="toc-sec-ggproto-instances" class="nav-link" data-scroll-target="#sec-ggproto-instances"><span class="header-section-number">19.4.3</span> Creando nuevas instancias</a></li>
  <li><a href="#sec-ggproto-subclass" id="toc-sec-ggproto-subclass" class="nav-link" data-scroll-target="#sec-ggproto-subclass"><span class="header-section-number">19.4.4</span> Creando subclases</a></li>
  <li><a href="#sec-ggproto-style" id="toc-sec-ggproto-style" class="nav-link" data-scroll-target="#sec-ggproto-style"><span class="header-section-number">19.4.5</span> Guía de estilo para ggproto</a></li>
  </ul>
</li>
  </ul></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content"><header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./extending.html">Temas avanzados</a></li><li class="breadcrumb-item"><a href="./internals.html"><span class="chapter-number">19</span>&nbsp; <span class="chapter-title">Internos de ggplot2</span></a></li></ol></nav><div class="quarto-title">
<h1 class="title"><span id="sec-internals" class="quarto-section-identifier"><span class="chapter-number">19</span>&nbsp; <span class="chapter-title">Internos de ggplot2</span></span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header><div class="callout callout-style-simple callout-note">
<div class="callout-body d-flex">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-body-container">
<p>You are reading the work-in-progress third edition of the ggplot2 book. This chapter should be readable but is currently undergoing final polishing.</p>
</div>
</div>
</div>
<p>A lo largo de este libro hemos descrito ggplot2 desde la perspectiva de un usuario más que de un desarrollador. Desde el punto de vista del usuario, lo importante es entender cómo funciona la interfaz de ggplot2. Para realizar una visualización de datos, el usuario necesita saber cómo se pueden usar funciones como <code>ggplot()</code> y <code>geom_point()</code> para <em>especificar</em> un gráfico, pero muy pocos usuarios necesitan comprender cómo ggplot2 traduce esta especificación del gráfico en una imagen. . Sin embargo, para un desarrollador de ggplot2 que espera diseñar extensiones, esta comprensión es primordial.</p>
<p>Al dar el salto de usuario a desarrollador, es común encontrar frustraciones porque la naturaleza de la <em>interfaz</em> ggplot2 es muy diferente a la estructura de la <em>maquinaria</em> subyacente que la hace funcionar. A medida que extender ggplot2 se vuelve más común, también lo hace la frustración relacionada con comprender cómo encaja todo. Este capítulo está dedicado a proporcionar una descripción de cómo funciona ggplot2 “detrás de las cortinas”. Nos centramos en el diseño del sistema más que en los detalles técnicos de su implementación, y el objetivo es proporcionar una comprensión conceptual de cómo encajan las piezas. Comenzamos con una descripción general del proceso que se desarrolla cuando se traza un objeto ggplot y luego profundizamos en los detalles, describiendo cómo los datos fluyen a través de todo este proceso y terminan como elementos visuales en su trama.</p>
<section id="sec-plot-method" class="level2" data-number="19.1"><h2 data-number="19.1" class="anchored" data-anchor-id="sec-plot-method">
<span class="header-section-number">19.1</span> El método <code>plot()</code>
</h2>
<p>Para comprender la maquinaria que sustenta ggplot2, es importante reconocer que casi todo lo relacionado con el dibujo de la trama ocurre cuando imprimes el objeto ggplot, no cuando lo construyes. Por ejemplo, en el código siguiente, el objeto <code>p</code> es una especificación abstracta de los datos de la trama, las capas, etc. No construye la imagen en sí:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb1"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">p</span> <span class="op">&lt;-</span> <span class="fu">ggplot</span><span class="op">(</span><span class="va">mpg</span>, <span class="fu">aes</span><span class="op">(</span><span class="va">displ</span>, <span class="va">hwy</span>, color <span class="op">=</span> <span class="va">drv</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">geom_point</span><span class="op">(</span>position <span class="op">=</span> <span class="st">"jitter"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_smooth</span><span class="op">(</span>method <span class="op">=</span> <span class="st">"lm"</span>, formula <span class="op">=</span> <span class="va">y</span> <span class="op">~</span> <span class="va">x</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">facet_wrap</span><span class="op">(</span><span class="fu">vars</span><span class="op">(</span><span class="va">year</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">ggtitle</span><span class="op">(</span><span class="st">"A plot for expository purposes"</span><span class="op">)</span></span></code></pre></div><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>ggplot2 está diseñado de esta manera para permitir al usuario agregar nuevos elementos a un gráfico sin necesidad de volver a calcular nada. Una implicación de esto es que si quieres entender la mecánica de ggplot2, tienes que seguir tu trama a medida que avanza por la madriguera del conejo <code><a href="https://rdrr.io/r/graphics/plot.default.html">plot()</a></code><a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a>. Puede inspeccionar el método de impresión para objetos ggplot escribiendo <code>ggplot2:::plot.ggplot</code> en la consola, pero para este capítulo trabajaremos con una versión simplificada. Reducido a lo esencial, el método de trazado ggplot2 tiene la misma estructura que la siguiente función <code>ggprint()</code>:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb2"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">ggprint</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">data</span> <span class="op">&lt;-</span> <span class="fu">ggplot_build</span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span>  <span class="va">gtable</span> <span class="op">&lt;-</span> <span class="fu">ggplot_gtable</span><span class="op">(</span><span class="va">data</span><span class="op">)</span></span>
<span>  <span class="fu">grid</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/grid/grid.newpage.html">grid.newpage</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="fu">grid</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/grid/grid.draw.html">grid.draw</a></span><span class="op">(</span><span class="va">gtable</span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/invisible.html">invisible</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Esta función no maneja todos los casos de uso posibles, pero es suficiente para dibujar el gráfico especificado anteriormente:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb3"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">ggprint</span><span class="op">(</span><span class="va">p</span><span class="op">)</span> </span></code></pre></div><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="internals_files/figure-html/unnamed-chunk-5-1.png" class="img-fluid figure-img" width="2100"></p>
</figure>
</div>
</div>
</div>
<p>El código de nuestro método de impresión simplificado revela cuatro pasos distintos:</p>
<ul>
<li><p>Primero, llama a <code>ggplot_build()</code> donde los datos de cada capa se preparan y organizan en un formato estandarizado adecuado para trazar.</p></li>
<li><p>En segundo lugar, los datos preparados se pasan a <code>ggplot_gtable()</code> y los convierte en elementos gráficos almacenados en una gtable (volveremos a eso más adelante).</p></li>
<li><p>En tercer lugar, el objeto gtable se convierte en una imagen con la ayuda del paquete grid.</p></li>
<li><p>Cuarto, el objeto ggplot original se devuelve de forma invisible al usuario.</p></li>
</ul>
<p>Una cosa que este proceso revela es que ggplot2 no realiza ningún dibujo de bajo nivel: su responsabilidad termina cuando se ha creado el objeto <code>gtable</code>. El paquete gtable (que implementa la clase gtable) tampoco realiza ningún dibujo. Todo el dibujo lo realiza el paquete grid junto con el dispositivo gráfico activo. Este es un punto importante, ya que significa que ggplot2, o cualquier extensión de ggplot2, no se preocupa por el meollo de la creación de la salida visual. Más bien, su trabajo es convertir los datos del usuario a una o más primitivas gráficas como polígonos, líneas, puntos, etc. y luego entregar la responsabilidad al paquete grid.</p>
<p>Aunque no es estrictamente correcto hacerlo, nos referiremos a esta conversión a primitivas gráficas como <strong>proceso de renderizado</strong>. Las siguientes dos secciones siguen los datos a través de la madriguera del conejo de renderizado a través del paso de compilación (<a href="#sec-ggplotbuild" class="quarto-xref"><span>Sección 19.2</span></a>) y el paso de gtable (<a href="#sec-ggplotgtable" class="quarto-xref"><span>Sección 19.3</span></a>) después de lo cual, algo así como Alicia en la novela de Lewis Carroll, finalmente llega a la cuadrícula. El país de las maravillas como una colección de primitivos gráficos.</p>
</section><section id="sec-ggplotbuild" class="level2" data-number="19.2"><h2 data-number="19.2" class="anchored" data-anchor-id="sec-ggplotbuild">
<span class="header-section-number">19.2</span> El paso de construcción</h2>
<!-- As may be apparent from the section above, the main actor in the rendering process is the layer data, and the rendering process is really a long progression of steps to convert the data from the format supplied by the user, to a format that fits with the graphic primitives needed to create the desired visual elements. This also means that to gain an understanding of the mechanics of ggplot2 we must understand how data flows through the mechanics and how it transforms along the way. -->
<p><code>ggplot_build()</code>, como se analizó anteriormente, toma la representación declarativa construida con la API pública y la aumenta preparando los datos para su conversión a primitivas gráficas.</p>
<section id="preparación-de-datos" class="level3" data-number="19.2.1"><h3 data-number="19.2.1" class="anchored" data-anchor-id="preparación-de-datos">
<span class="header-section-number">19.2.1</span> Preparación de datos</h3>
<p>La primera parte del procesamiento es obtener los datos asociados con cada capa y ponerlos en un formato predecible. Una capa puede proporcionar datos de una de tres maneras: puede proporcionar los suyos propios (por ejemplo, si el argumento <code>data</code> de una geom es un marco de datos), puede heredar los datos globales proporcionados a <code>ggplot()</code>, o de lo contrario, podría proporcionar una función que devuelva un marco de datos cuando se aplica a los datos globales. En los tres casos, el resultado es un marco de datos que se pasa al diseño del trazado, que organiza sistemas de coordenadas y facetas. Cuando esto sucede, los datos se pasan primero al sistema de coordenadas de la trama, que puede cambiarlos (pero generalmente no lo hace), y luego a la faceta que inspecciona los datos para determinar cuántos paneles debe tener la trama y cómo deben organizarse. . Durante este proceso, los datos asociados con cada capa se aumentarán con una columna <code>PANEL</code>. Esta columna (debe) mantenerse durante todo el proceso de renderizado y se utiliza para vincular cada fila de datos a un panel de facetas específico en el gráfico final.</p>
<p>La última parte de la preparación de datos es convertir los datos de la capa en valores estéticos calculados. Esto implica evaluar todas las expresiones estéticas de <code>aes()</code> en los datos de la capa. Además, si no se da explícitamente, la estética <code>group</code> se calcula a partir de la interacción de todas las estéticas no continuas. La estética del <code>group</code> es, como <code>PANEL</code>, una columna especial que debe mantenerse durante todo el procesamiento. Como ejemplo, el gráfico <code>p</code> creado anteriormente contiene solo la capa especificada por <code>geom_point()</code> y al final del proceso de preparación de datos, las primeras 10 filas de los datos asociados con esta capa se ven así:</p>
<div class="cell">
<pre><code>#&gt;      x  y colour PANEL group
#&gt; 1  1.8 29      f     1     2
#&gt; 2  1.8 29      f     1     2
#&gt; 3  2.0 31      f     2     2
#&gt; 4  2.0 30      f     2     2
#&gt; 5  2.8 26      f     1     2
#&gt; 6  2.8 26      f     1     2
#&gt; 7  3.1 27      f     2     2
#&gt; 8  1.8 26      4     1     1
#&gt; 9  1.8 25      4     1     1
#&gt; 10 2.0 28      4     2     1</code></pre>
</div>
</section><section id="transformación-de-datos" class="level3" data-number="19.2.2"><h3 data-number="19.2.2" class="anchored" data-anchor-id="transformación-de-datos">
<span class="header-section-number">19.2.2</span> Transformación de datos</h3>
<p>Una vez que los datos de la capa se han extraído y convertido a un formato predecible, se someten a una serie de transformaciones hasta que tienen el formato esperado por la geometría de la capa.</p>
<p>El primer paso es aplicar cualquier transformación de escala a las columnas de los datos. Es en esta etapa del proceso que cualquier argumento a favor de <code>trans</code> en una escala tiene efecto, y toda la representación posterior tendrá lugar en este espacio transformado. Esta es la razón por la que establecer una transformación de posición en la escala tiene un efecto diferente que establecerla en el sistema de coordenadas. Si la transformación se especifica en la escala, se aplica <em>antes</em> de cualquier otro cálculo, pero si se especifica en el sistema de coordenadas, la transformación se aplica <em>después</em> de esos cálculos. Por ejemplo, nuestro gráfico original <code>p</code> no implica transformaciones de escala, por lo que los datos de la capa permanecen intactos en esta etapa. Las primeras tres filas se muestran a continuación:</p>
<div class="cell">
<pre><code>#&gt;     x  y colour PANEL group
#&gt; 1 1.8 29      f     1     2
#&gt; 2 1.8 29      f     1     2
#&gt; 3 2.0 31      f     2     2</code></pre>
</div>
<p>Por el contrario, si nuestro objeto de trazado es <code>p + scale_x_log10()</code> e inspeccionamos los datos de la capa en este punto del procesamiento, vemos que la variable <code>x</code> se ha transformado apropiadamente:</p>
<div class="cell">
<pre><code>#&gt;       x  y colour PANEL group
#&gt; 1 0.255 29      f     1     2
#&gt; 2 0.255 29      f     1     2
#&gt; 3 0.301 31      f     2     2</code></pre>
</div>
<p>El segundo paso del proceso es mapear la estética de la posición utilizando las escalas de posición, que se despliegan de manera diferente según el tipo de escala involucrada. Para escalas de posición continuas, como las utilizadas en nuestro ejemplo, la función fuera de límites especificada en el argumento <code>oob</code> (<a href="scales-guides.html#sec-oob" class="quarto-xref"><span>Sección 14.4</span></a>) se aplica en este punto y los valores <code>NA</code> en los datos de la capa se eliminan. . Esto hace poca diferencia para <code>p</code>, pero si estuviéramos graficando <code>p + xlim(2, 8)</code> en lugar de ello, la función <code>oob</code> – <code><a href="https://scales.r-lib.org/reference/oob.html">scales::censor()</a></code> en este caso – reemplazaría a <code>x</code> valores por debajo de 2 con <code>NA</code> como se ilustra a continuación:</p>
<div class="cell">
<pre><code>#&gt; Warning: Removed 22 rows containing non-finite outside the scale range
#&gt; (`stat_smooth()`).
#&gt;    x  y colour PANEL group
#&gt; 1 NA 29      f     1     2
#&gt; 2 NA 29      f     1     2
#&gt; 3  2 31      f     2     2</code></pre>
</div>
<p>Para posiciones discretas, el cambio es más radical, porque los valores coinciden con los valores de <code>llimits</code> o la especificación de interrupciones con <code>breaks</code> proporcionada por el usuario y luego se convierten a posiciones con valores enteros. Finalmente, para escalas de posición agrupadas, los datos continuos primero se cortan en bins usando el argumento <code>breaks</code>, y la posición de cada bin se establece en el punto medio de su rango. La razón para realizar el mapeo en esta etapa del proceso es la coherencia: no importa qué tipo de escala de posición se utilice, parecerá continua para los cálculos de estadísticas y geom. Esto es importante porque, de lo contrario, los cálculos como la esquiva y la fluctuación fallarían en escalas discretas.</p>
<p>En la tercera etapa de esta transformación, los datos se entregan a la capa de estadísticas donde se lleva a cabo cualquier transformación estadística. El procedimiento es el siguiente: primero, la estadística puede inspeccionar los datos y modificar sus parámetros, luego realizar una preparación única de los datos. A continuación, los datos de la capa se dividen en <code>PANEL</code> y <code>group</code>, y las estadísticas se calculan antes de volver a ensamblar los datos.<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a> Una vez que los datos se han vuelto a ensamblar en su nueva forma, pasan por otro proceso de mapeo estético. Aquí es donde se agrega a los datos cualquier estética cuyo cálculo se haya retrasado usando <code>stat()</code> (o la antigua notación <code>..var..</code>). Observe que esta es la razón por la cual las expresiones <code>stat()</code>, incluida la fórmula utilizada para especificar el modelo de regresión en la capa <code>geom_smooth()</code> de nuestro gráfico de ejemplo <code>p</code>, no pueden hacer referencia a los datos originales. Simplemente no existe en este momento.</p>
<p>Como ejemplo, considere la segunda capa de nuestro gráfico, que produce las regresiones lineales. Antes de realizar los cálculos estadísticos, los datos de esta capa simplemente contienen las coordenadas y las columnas <code>PANEL</code> y <code>group</code> requeridas.</p>
<div class="cell">
<pre><code>#&gt;     x  y colour PANEL group
#&gt; 1 1.8 29      f     1     2
#&gt; 2 1.8 29      f     1     2
#&gt; 3 2.0 31      f     2     2</code></pre>
</div>
<p>Una vez realizados los cálculos estadísticos, los datos de la capa cambian considerablemente:</p>
<div class="cell">
<pre><code>#&gt;      x    y ymin ymax    se flipped_aes colour PANEL group
#&gt; 1 1.80 24.3 23.1 25.6 0.625       FALSE      4     1     1
#&gt; 2 1.86 24.2 22.9 25.4 0.612       FALSE      4     1     1
#&gt; 3 1.92 24.0 22.8 25.2 0.598       FALSE      4     1     1</code></pre>
</div>
<p>En este punto, la geom reemplaza a la estadística (casi). La primera acción que toma es inspeccionar los datos, actualizar sus parámetros y posiblemente realizar una modificación de primer paso de los datos (la misma configuración que para las estadísticas). Posiblemente aquí es donde algunas de las columnas se reparametrizan, p.&nbsp;<code>x</code>+<code>width</code> se cambia a <code>xmin</code>+<code>xmax</code>. Después de esto se aplica el ajuste de posición, de modo que p.e. las barras superpuestas se apilan, etc. Para nuestro gráfico de ejemplo <code>p</code>, es en este paso que se aplica la fluctuación en la primera capa del gráfico y las coordenadas <code>x</code> e <code>y</code> se alteran:</p>
<div class="cell">
<pre><code>#&gt;      x    y colour PANEL group
#&gt; 1 1.84 28.7      f     1     2
#&gt; 2 1.77 29.1      f     1     2
#&gt; 3 2.03 31.3      f     2     2</code></pre>
</div>
<p>A continuación, y quizás sorprendentemente, todas las escalas de posición se restablecen, se vuelven a entrenar y se aplican a los datos de la capa. Pensándolo bien, esto es absolutamente necesario porque, por ejemplo, el apilamiento puede cambiar drásticamente el rango de uno de los ejes. En algunos casos (por ejemplo, en el ejemplo de histograma anterior), es posible que una de las estéticas de posición ni siquiera esté disponible hasta después de los cálculos de estadísticas y, si las escalas no se volvieran a entrenar, nunca se entrenarían.</p>
<p>La última parte de la transformación de datos es entrenar y mapear todas las estéticas no posicionales, es decir, convertir cualquier entrada discreta o continua que esté asignada a parámetros gráficos como colores, tipos de línea, tamaños, etc. Además, se agrega cualquier estética predeterminada de geom. de modo que los datos ahora estén en un estado predecible para la geom. En el último paso, tanto la estadística como la faceta tienen una última oportunidad de modificar los datos en su forma asignada final con sus métodos <code>finish_data()</code> antes de finalizar el paso de compilación. Para el objeto de trazado <code>p</code>, las primeras filas del estado final de los datos de la capa se ven así:</p>
<div class="cell">
<pre><code>#&gt;    colour    x    y PANEL group shape size fill alpha stroke
#&gt; 1 #00BA38 1.83 29.1     1     2    19  1.5   NA    NA    0.5
#&gt; 2 #00BA38 1.79 29.2     1     2    19  1.5   NA    NA    0.5
#&gt; 3 #00BA38 1.99 30.7     2     2    19  1.5   NA    NA    0.5</code></pre>
</div>
</section><section id="salida" class="level3" data-number="19.2.3"><h3 data-number="19.2.3" class="anchored" data-anchor-id="salida">
<span class="header-section-number">19.2.3</span> Salida</h3>
<p>El valor de retorno de <code>ggplot_build()</code> es una estructura de lista con la clase <code>ggplot_built</code>. Contiene los datos calculados, así como un objeto <code>Layout</code> que contiene información sobre el sistema de coordenadas entrenado y las facetas. Además, contiene una copia del objeto de la trama original, pero ahora con escalas entrenadas.</p>
</section></section><section id="sec-ggplotgtable" class="level2" data-number="19.3"><h2 data-number="19.3" class="anchored" data-anchor-id="sec-ggplotgtable">
<span class="header-section-number">19.3</span> El paso gtable</h2>
<p>El propósito de <code>ggplot_gtable()</code> es tomar el resultado del paso de compilación y, con la ayuda del paquete gtable, convertirlo en un objeto que se pueda trazar usando grid (hablaremos más sobre gtable en <a href="ext-springs.html#sec-tabular-grid" class="quarto-xref"><span>Sección 21.5.6</span></a>). En este punto, los principales elementos responsables de cálculos adicionales son las geomas, el sistema de coordenadas, la faceta y el tema. Las estadísticas y los ajustes de posición ya han contribuido.</p>
<section id="renderizando-los-paneles" class="level3" data-number="19.3.1"><h3 data-number="19.3.1" class="anchored" data-anchor-id="renderizando-los-paneles">
<span class="header-section-number">19.3.1</span> Renderizando los paneles</h3>
<p>Lo primero que sucede es que los datos se convierten en su representación gráfica. Esto sucede en dos pasos. Primero, cada capa se convierte en una lista de objetos gráficos (<code>grobs</code>). Al igual que con las estadísticas, la conversión se realiza dividiendo los datos, primero por <code>PANEL</code> y luego por <code>group</code>, con la posibilidad de que geom intercepte esta división por razones de rendimiento. Si bien ya se ha realizado gran parte de la preparación de datos, no es raro que geom realice alguna transformación adicional de los datos durante este paso. Una parte crucial es transformar y normalizar los datos de posición. Esto lo hace el sistema de coordenadas y, si bien a menudo significa simplemente que los datos se normalizan en función de los límites del sistema de coordenadas, también puede incluir transformaciones radicales, como convertir las posiciones en coordenadas polares. El resultado de esto es para cada capa una lista de objetos <code>gList</code> correspondientes a cada panel en el diseño de facetas. Después de esto, la faceta se hace cargo y ensambla los paneles. Para ello, primero recopila los grobs para cada panel de las capas, junto con franjas de renderizado, fondos, líneas de cuadrícula y ejes según el tema, y combina todo esto en una única gList para cada panel. Luego procede a organizar todos estos paneles en una tabla basada en el diseño del panel calculado. Para la mayoría de los gráficos, esto es simple ya que solo hay un panel, pero, por ejemplo, trazar usando <code>facet_wrap()</code> puede ser bastante complicado. La salida es la base del objeto gtable final. En esta etapa del proceso, nuestro gráfico de ejemplo <code>p</code> se ve así:</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="internals_files/figure-html/unnamed-chunk-14-1.png" class="img-fluid figure-img" width="2100"></p>
</figure>
</div>
</div>
</div>
</section><section id="agregar-guías" class="level3" data-number="19.3.2"><h3 data-number="19.3.2" class="anchored" data-anchor-id="agregar-guías">
<span class="header-section-number">19.3.2</span> Agregar guías</h3>
<p>Hay dos tipos de guías en ggplot2: ejes y leyendas. Como ilustra nuestro gráfico <code>p</code>, en este punto los ejes ya se han renderizado y ensamblado junto con los paneles, pero aún faltan las leyendas. Representar las leyendas es un proceso complicado en el que primero se entrena una guía para cada escala. Luego, potencialmente se fusionan varias guías si su mapeo lo permite, antes de que a las capas que contribuyen a la leyenda se les soliciten claves para cada clave de la leyenda. Estos elementos clave luego se ensamblan en capas y se combinan hasta formar la leyenda final en un proceso que recuerda bastante a cómo se combinan las capas en la tabla de paneles. Al final, el resultado es una tabla g que contiene cada cuadro de leyenda organizado y diseñado de acuerdo con el tema y las especificaciones de la guía. Una vez creada, la gtable guía se agrega a la gtable principal de acuerdo con la configuración del tema <code>legend.position</code>. En esta etapa, nuestro argumento de ejemplo está completo en la mayoría de los aspectos: lo único que falta es el título.</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="internals_files/figure-html/unnamed-chunk-15-1.png" class="img-fluid figure-img" width="2100"></p>
</figure>
</div>
</div>
</div>
</section><section id="añadiendo-adorno" class="level3" data-number="19.3.3"><h3 data-number="19.3.3" class="anchored" data-anchor-id="añadiendo-adorno">
<span class="header-section-number">19.3.3</span> Añadiendo adorno</h3>
<p>Lo único que queda es agregar título, subtítulo, leyenda y etiqueta, así como agregar fondo y márgenes, momento en el cual la tabla final estará lista.</p>
</section><section id="salida-1" class="level3" data-number="19.3.4"><h3 data-number="19.3.4" class="anchored" data-anchor-id="salida-1">
<span class="header-section-number">19.3.4</span> Salida</h3>
<p>En este punto, ggplot2 está listo para entregarse a grid. Nuestro proceso de renderizado es más o menos equivalente al código siguiente y el resultado final es, como se describe anteriormente, una gtable:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb12"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">p_built</span> <span class="op">&lt;-</span> <span class="fu">ggplot_build</span><span class="op">(</span><span class="va">p</span><span class="op">)</span></span>
<span><span class="va">p_gtable</span> <span class="op">&lt;-</span> <span class="fu">ggplot_gtable</span><span class="op">(</span><span class="va">p_built</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/class.html">class</a></span><span class="op">(</span><span class="va">p_gtable</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "gtable" "gTree"  "grob"   "gDesc"</span></span></code></pre></div><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Lo que es menos obvio es que las dimensiones del objeto son impredecibles y dependerán tanto del facetado como de la ubicación de la leyenda y de los títulos que se dibujen. Por lo tanto, no se recomienda depender de la ubicación de las filas y columnas en su código, en caso de que desee modificar aún más la gtable. Sin embargo, todos los elementos de gtable tienen nombre, por lo que aún es posible recuperarlos de manera confiable, p.&nbsp;el grob sostiene el eje y superior izquierdo con un poco de trabajo. A modo de ilustración, la gtable para nuestro gráfico <code>p</code> se muestra en el siguiente código:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb13"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">p_gtable</span></span>
<span><span class="co">#&gt; TableGrob (17 x 17) "layout": 25 grobs</span></span>
<span><span class="co">#&gt;     z         cells             name</span></span>
<span><span class="co">#&gt; 1   0 ( 1-17, 1-17)       background</span></span>
<span><span class="co">#&gt; 2   1 (10-10, 7- 7)        panel-1-1</span></span>
<span><span class="co">#&gt; 3   1 (10-10,11-11)        panel-2-1</span></span>
<span><span class="co">#&gt; 4   3 ( 8- 8, 7- 7)       axis-t-1-1</span></span>
<span><span class="co">#&gt; 5   3 ( 8- 8,11-11)       axis-t-2-1</span></span>
<span><span class="co">#&gt; 6   3 (11-11, 7- 7)       axis-b-1-1</span></span>
<span><span class="co">#&gt; 7   3 (11-11,11-11)       axis-b-2-1</span></span>
<span><span class="co">#&gt; 8   3 (10-10,10-10)       axis-l-1-2</span></span>
<span><span class="co">#&gt; 9   3 (10-10, 6- 6)       axis-l-1-1</span></span>
<span><span class="co">#&gt; 10  3 (10-10,12-12)       axis-r-1-2</span></span>
<span><span class="co">#&gt; 11  3 (10-10, 8- 8)       axis-r-1-1</span></span>
<span><span class="co">#&gt; 12  2 ( 9- 9, 7- 7)      strip-t-1-1</span></span>
<span><span class="co">#&gt; 13  2 ( 9- 9,11-11)      strip-t-2-1</span></span>
<span><span class="co">#&gt; 14  4 ( 7- 7, 7-11)           xlab-t</span></span>
<span><span class="co">#&gt; 15  5 (12-12, 7-11)           xlab-b</span></span>
<span><span class="co">#&gt; 16  6 (10-10, 5- 5)           ylab-l</span></span>
<span><span class="co">#&gt; 17  7 (10-10,13-13)           ylab-r</span></span>
<span><span class="co">#&gt; 18  8 (10-10,15-15)  guide-box-right</span></span>
<span><span class="co">#&gt; 19  9 (10-10, 3- 3)   guide-box-left</span></span>
<span><span class="co">#&gt; 20 10 (14-14, 7-11) guide-box-bottom</span></span>
<span><span class="co">#&gt; 21 11 ( 5- 5, 7-11)    guide-box-top</span></span>
<span><span class="co">#&gt; 22 12 (10-10, 7-11) guide-box-inside</span></span>
<span><span class="co">#&gt; 23 13 ( 4- 4, 7-11)         subtitle</span></span>
<span><span class="co">#&gt; 24 14 ( 3- 3, 7-11)            title</span></span>
<span><span class="co">#&gt; 25 15 (15-15, 7-11)          caption</span></span>
<span><span class="co">#&gt;                                             grob</span></span>
<span><span class="co">#&gt; 1                rect[plot.background..rect.707]</span></span>
<span><span class="co">#&gt; 2                       gTree[panel-1.gTree.587]</span></span>
<span><span class="co">#&gt; 3                       gTree[panel-2.gTree.602]</span></span>
<span><span class="co">#&gt; 4                                 zeroGrob[NULL]</span></span>
<span><span class="co">#&gt; 5                                 zeroGrob[NULL]</span></span>
<span><span class="co">#&gt; 6            absoluteGrob[GRID.absoluteGrob.606]</span></span>
<span><span class="co">#&gt; 7            absoluteGrob[GRID.absoluteGrob.606]</span></span>
<span><span class="co">#&gt; 8                                 zeroGrob[NULL]</span></span>
<span><span class="co">#&gt; 9            absoluteGrob[GRID.absoluteGrob.614]</span></span>
<span><span class="co">#&gt; 10                                zeroGrob[NULL]</span></span>
<span><span class="co">#&gt; 11                                zeroGrob[NULL]</span></span>
<span><span class="co">#&gt; 12                                 gtable[strip]</span></span>
<span><span class="co">#&gt; 13                                 gtable[strip]</span></span>
<span><span class="co">#&gt; 14                                zeroGrob[NULL]</span></span>
<span><span class="co">#&gt; 15 titleGrob[axis.title.x.bottom..titleGrob.669]</span></span>
<span><span class="co">#&gt; 16   titleGrob[axis.title.y.left..titleGrob.672]</span></span>
<span><span class="co">#&gt; 17                                zeroGrob[NULL]</span></span>
<span><span class="co">#&gt; 18                             gtable[guide-box]</span></span>
<span><span class="co">#&gt; 19                                zeroGrob[NULL]</span></span>
<span><span class="co">#&gt; 20                                zeroGrob[NULL]</span></span>
<span><span class="co">#&gt; 21                                zeroGrob[NULL]</span></span>
<span><span class="co">#&gt; 22                                zeroGrob[NULL]</span></span>
<span><span class="co">#&gt; 23         zeroGrob[plot.subtitle..zeroGrob.704]</span></span>
<span><span class="co">#&gt; 24          titleGrob[plot.title..titleGrob.703]</span></span>
<span><span class="co">#&gt; 25          zeroGrob[plot.caption..zeroGrob.705]</span></span></code></pre></div><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>La trama final, como era de esperar, parece idéntica a la original:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb14"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">grid</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/grid/grid.newpage.html">grid.newpage</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu">grid</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/grid/grid.draw.html">grid.draw</a></span><span class="op">(</span><span class="va">p_gtable</span><span class="op">)</span></span></code></pre></div><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="internals_files/figure-html/unnamed-chunk-18-1.png" class="img-fluid figure-img" width="2100"></p>
</figure>
</div>
</div>
</div>
</section></section><section id="sec-ggproto" class="level2" data-number="19.4"><h2 data-number="19.4" class="anchored" data-anchor-id="sec-ggproto">
<span class="header-section-number">19.4</span> Presentando ggproto</h2>
<p><a href="#sec-plot-method" class="quarto-xref"><span>Sección 19.1</span></a> a <a href="#sec-ggplotgtable" class="quarto-xref"><span>Sección 19.3</span></a> se centran en la secuencia de eventos involucrados en la construcción de un ggplot, pero son intencionalmente vagos en cuanto a qué tipo de objetos de programación realizan este trabajo.</p>
<p>Todos los objetos ggplot2 se crean utilizando el sistema <strong>ggproto</strong> para programación orientada a objetos, y es inusual que solo lo use ggplot2. Esto es una especie de accidente histórico: ggplot2 originalmente usaba proto <span class="citation" data-cites="proto">(<a href="#ref-proto" role="doc-biblioref">Grothendieck, Kates, y Petzoldt 2016</a>)</span> para programación orientada a objetos, lo que se convirtió en un problema una vez que surgió la necesidad de un mecanismo de extensión oficial debido a las limitaciones del sistema proto. Los intentos de cambiar ggplot2 a otros sistemas como R6 <span class="citation" data-cites="R6">(<a href="#ref-R6" role="doc-biblioref">Chang 2020</a>)</span> resultaron difíciles, y crear un sistema orientado a objetos específico para las necesidades de ggplot2 resultó ser la solución menos mala.</p>
<p>Comprender el sistema de programación orientado a objetos ggproto es importante si desea escribir extensiones de ggplot2. Encontraremos objetos ggproto tal como los usa ggplot2 en <a href="extensions.html" class="quarto-xref"><span>Capítulo 20</span></a> y <a href="ext-springs.html" class="quarto-xref"><span>Capítulo 21</span></a>. Al igual que el sistema R6 más conocido, ggproto utiliza semántica de referencia y permite la herencia y el acceso a métodos de las clases principales. Va acompañado de un conjunto de principios de diseño que, si bien ggproto no aplica, son esenciales para comprender cómo se utiliza el sistema en ggplot2. Para ilustrar estos conceptos, esta sección presenta la mecánica central de ggproto en una forma simplificada.</p>
<section id="objetos-ggproto" class="level3" data-number="19.4.1"><h3 data-number="19.4.1" class="anchored" data-anchor-id="objetos-ggproto">
<span class="header-section-number">19.4.1</span> objetos ggproto</h3>
<p>La creación de un nuevo objeto ggproto se realiza con la función <code>ggproto()</code>, que toma el nombre de la nueva clase como primer argumento, y otro objeto ggproto del cual heredará el nuevo como segundo argumento. Por ejemplo, podríamos crear un objeto ggproto (aunque no tenga ninguna funcionalidad útil) con el siguiente comando:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb15"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">NewObject</span> <span class="op">&lt;-</span> <span class="fu">ggproto</span><span class="op">(</span></span>
<span>  `_class` <span class="op">=</span> <span class="cn">NULL</span>, </span>
<span>  `_inherits` <span class="op">=</span> <span class="cn">NULL</span></span>
<span><span class="op">)</span></span></code></pre></div><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Por convención, los objetos ggproto se denominan usando “UpperCamelCase”, en el que cada palabra comienza con una letra mayúscula. También es convencional omitir los nombres de los argumentos <code>`_class`</code> y <code>`_inherits`</code>, por lo que la forma convencional de este comando sería la siguiente:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb16"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">NewObject</span> <span class="op">&lt;-</span> <span class="fu">ggproto</span><span class="op">(</span><span class="cn">NULL</span>, <span class="cn">NULL</span><span class="op">)</span></span></code></pre></div><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Si imprimimos este objeto vemos que efectivamente es un objeto ggproto, pero no aparece ninguna otra información.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb17"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">NewObject</span> </span>
<span><span class="co">#&gt; &lt;ggproto object: Class gg&gt;</span></span></code></pre></div><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section><section id="creando-nuevas-clases" class="level3" data-number="19.4.2"><h3 data-number="19.4.2" class="anchored" data-anchor-id="creando-nuevas-clases">
<span class="header-section-number">19.4.2</span> Creando nuevas clases</h3>
<p>Para crear una nueva clase ggproto, lo único que es estrictamente necesario es proporcionar un nombre de clase como primer argumento de <code>ggproto()</code>. Un comando mínimo que define una nueva clase podría verse así:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb18"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">NewClass</span> <span class="op">&lt;-</span> <span class="fu">ggproto</span><span class="op">(</span><span class="st">"NewClass"</span>, <span class="cn">NULL</span><span class="op">)</span></span></code></pre></div><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>La variable <code>NewClass</code> todavía hace referencia a un objeto ggproto, pero podemos verificar que tiene el nombre de clase deseado imprimiéndolo:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb19"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">NewClass</span></span>
<span><span class="co">#&gt; &lt;ggproto object: Class NewClass, gg&gt;</span></span></code></pre></div><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Sin embargo, hasta ahora lo único que hemos hecho es crear un objeto que especifica una clase. El objeto <code>NewClass</code> no hace nada. Para crear una clase ggproto que haga algo útil, debemos proporcionar una lista de campos y métodos cuando definimos la clase. En este contexto, los “campos” se utilizan para almacenar datos relevantes para el objeto y los “métodos” son funciones que pueden utilizar los datos almacenados en el objeto. Los campos y métodos se construyen de la misma manera y no se tratan de manera diferente desde la perspectiva del usuario.</p>
<p>Para ilustrar esto, crearemos una nueva clase llamada <code>Person</code> que se usará para almacenar y manipular información sobre una persona. Podemos hacer esto proporcionando a la función <code>ggproto()</code> pares nombre/valor:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb20"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">Person</span> <span class="op">&lt;-</span> <span class="fu">ggproto</span><span class="op">(</span><span class="st">"Person"</span>, <span class="cn">NULL</span>,</span>
<span>  </span>
<span>  <span class="co"># campos                  </span></span>
<span>  given_name <span class="op">=</span> <span class="cn">NA</span>,</span>
<span>  family_name <span class="op">=</span> <span class="cn">NA</span>,</span>
<span>  birth_date <span class="op">=</span> <span class="cn">NA</span>,</span>
<span>  </span>
<span>  <span class="co"># métodos</span></span>
<span>  full_name <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">self</span>, <span class="va">family_last</span> <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw">if</span><span class="op">(</span><span class="va">family_last</span> <span class="op">==</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="va">self</span><span class="op">$</span><span class="va">given_name</span>, <span class="va">self</span><span class="op">$</span><span class="va">family_name</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="va">self</span><span class="op">$</span><span class="va">family_name</span>, <span class="va">self</span><span class="op">$</span><span class="va">given_name</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span>,</span>
<span>  age <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">self</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">days_old</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html">Sys.Date</a></span><span class="op">(</span><span class="op">)</span> <span class="op">-</span> <span class="va">self</span><span class="op">$</span><span class="va">birth_date</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/Round.html">floor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/integer.html">as.integer</a></span><span class="op">(</span><span class="va">days_old</span><span class="op">)</span> <span class="op">/</span> <span class="fl">365.25</span><span class="op">)</span></span>
<span>  <span class="op">}</span>,</span>
<span>  description <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">self</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="va">self</span><span class="op">$</span><span class="fu">full_name</span><span class="op">(</span><span class="op">)</span>, <span class="st">"is"</span>, <span class="va">self</span><span class="op">$</span><span class="fu">age</span><span class="op">(</span><span class="op">)</span>, <span class="st">"years old"</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">)</span></span></code></pre></div><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>La clase <code>Person</code> ahora está asociada con tres campos, correspondientes a <code>given_name</code> y <code>family_name</code> de una persona, así como su <code>birth_date</code>. También posee tres métodos: el método <code>full_name()</code> es una función que construye el nombre completo de la persona, usando la convención de colocar el nombre de pila primero y el apellido segundo, el método <code>age()</code> calcula la edad de la persona en años, y el método <code>description()</code> imprime una breve descripción de la persona.</p>
<p>Al imprimir el objeto se muestran los campos y métodos a los que está asociado:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb21"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">Person</span></span>
<span><span class="co">#&gt; &lt;ggproto object: Class Person, gg&gt;</span></span>
<span><span class="co">#&gt;     age: function</span></span>
<span><span class="co">#&gt;     birth_date: NA</span></span>
<span><span class="co">#&gt;     description: function</span></span>
<span><span class="co">#&gt;     family_name: NA</span></span>
<span><span class="co">#&gt;     full_name: function</span></span>
<span><span class="co">#&gt;     given_name: NA</span></span></code></pre></div><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>El objeto ggproto <code>Person</code> es esencialmente una plantilla para la clase, y podemos usarlo para crear registros específicos de personas individuales (discutido en <a href="#sec-ggproto-instances" class="quarto-xref"><span>Sección 19.4.3</span></a>). Si está familiarizado con otros sistemas de programación orientados a objetos, es posible que esperara algo un poco diferente: a menudo las nuevas clases se definen con una función constructora dedicada. Una peculiaridad de ggproto es que <code>ggproto()</code> no hace esto: más bien, el constructor de la clase es en sí mismo un objeto.</p>
<p>Otra cosa a tener en cuenta al definir métodos es el uso de <code>self</code> como primer argumento. Este es un argumento especial que se utiliza para darle al método acceso a los campos y métodos asociados con el objeto ggproto (consulte <a href="#sec-ggproto-subclass" class="quarto-xref"><span>Sección 19.4.4</span></a> para ver un ejemplo). El estatus especial de este argumento es evidente al imprimir un método ggproto:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb22"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">Person</span><span class="op">$</span><span class="va">full_name</span></span>
<span><span class="co">#&gt; &lt;ggproto method&gt;</span></span>
<span><span class="co">#&gt;   &lt;Wrapper function&gt;</span></span>
<span><span class="co">#&gt;     function(...) !!call2(name, !!!args)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;   &lt;Inner function (f)&gt;</span></span>
<span><span class="co">#&gt;     function (self, family_last = TRUE) </span></span>
<span><span class="co">#&gt; {</span></span>
<span><span class="co">#&gt;     if (family_last == TRUE) {</span></span>
<span><span class="co">#&gt;         return(paste(self$given_name, self$family_name))</span></span>
<span><span class="co">#&gt;     }</span></span>
<span><span class="co">#&gt;     return(paste(self$family_name, self$given_name))</span></span>
<span><span class="co">#&gt; }</span></span></code></pre></div><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Este resultado puede parecer un poco sorprendente: cuando definimos <code>full_name()</code> anteriormente solo proporcionamos el código listado como “función interna”. Lo que sucedió es que <code>ggproto()</code> automáticamente incluyó mi función dentro de una función contenedora que llama a mi código como función interna, al tiempo que garantiza que se use una definición apropiada de <code>self</code>. Cuando se imprime el método, la consola muestra tanto la función contenedora (normalmente de poco interés) como la función interna. La salida en este formato aparece en <a href="extensions.html" class="quarto-xref"><span>Capítulo 20</span></a> y <a href="ext-springs.html" class="quarto-xref"><span>Capítulo 21</span></a>.</p>
</section><section id="sec-ggproto-instances" class="level3" data-number="19.4.3"><h3 data-number="19.4.3" class="anchored" data-anchor-id="sec-ggproto-instances">
<span class="header-section-number">19.4.3</span> Creando nuevas instancias</h3>
<p>Ahora que hemos definido la clase <code>Person</code>, podemos crear instancias de la clase. Esto se hace pasando un objeto ggproto como segundo argumento a <code>ggproto()</code> y sin especificar un nuevo nombre de clase en el primer argumento. Por ejemplo, podemos crear nuevos objetos <code>Thomas</code> y <code>Danielle</code> que sean instancias de la clase <code>Person</code> de la siguiente manera:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb23"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">Thomas</span> <span class="op">&lt;-</span> <span class="fu">ggproto</span><span class="op">(</span><span class="cn">NULL</span>, <span class="va">Person</span>,</span>
<span>  given_name <span class="op">=</span> <span class="st">"Thomas Lin"</span>,</span>
<span>  family_name <span class="op">=</span> <span class="st">"Pedersen"</span>,</span>
<span>  birth_date <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op">(</span><span class="st">"1985/10/12"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">Danielle</span> <span class="op">&lt;-</span> <span class="fu">ggproto</span><span class="op">(</span><span class="cn">NULL</span>, <span class="va">Person</span>,</span>
<span>  given_name <span class="op">=</span> <span class="st">"Danielle Jasmine"</span>,</span>
<span>  family_name <span class="op">=</span> <span class="st">"Navarro"</span>,</span>
<span>  birth_date <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op">(</span><span class="st">"1977/09/12"</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Al especificar <code>NULL</code> como primer argumento, se le indica a <code>ggproto()</code> que no defina una nueva clase, sino que cree una nueva instancia de la clase especificada en el segundo argumento. Debido a que <code>Thomas</code> y <code>Danielle</code> son instancias de la clase <code>Person</code>, heredan automáticamente sus métodos <code>age()</code>, <code>full_name()</code> y <code>description()</code>:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb24"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">Thomas</span><span class="op">$</span><span class="fu">description</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "Thomas Lin Pedersen is 40 years old"</span></span>
<span></span>
<span><span class="va">Danielle</span><span class="op">$</span><span class="fu">description</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "Danielle Jasmine Navarro is 48 years old"</span></span></code></pre></div><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section><section id="sec-ggproto-subclass" class="level3" data-number="19.4.4"><h3 data-number="19.4.4" class="anchored" data-anchor-id="sec-ggproto-subclass">
<span class="header-section-number">19.4.4</span> Creando subclases</h3>
<p>En el ejemplo anterior creamos <code>Person</code> como una clase completamente nueva. En la práctica, casi nunca necesitarás hacer esto: en su lugar, probablemente crearás una subclase usando un objeto ggproto existente. Puede hacer esto especificando el nombre de la subclase y el objeto del cual debe heredar en la llamada a <code>ggproto()</code>:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb25"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># definir la subclase</span></span>
<span><span class="va">NewSubClass</span> <span class="op">&lt;-</span> <span class="fu">ggproto</span><span class="op">(</span><span class="st">"NewSubClass"</span>, <span class="va">Person</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># verificar que esto funcione</span></span>
<span><span class="va">NewSubClass</span></span>
<span><span class="co">#&gt; &lt;ggproto object: Class NewSubClass, Person, gg&gt;</span></span>
<span><span class="co">#&gt;     age: function</span></span>
<span><span class="co">#&gt;     birth_date: NA</span></span>
<span><span class="co">#&gt;     description: function</span></span>
<span><span class="co">#&gt;     family_name: NA</span></span>
<span><span class="co">#&gt;     full_name: function</span></span>
<span><span class="co">#&gt;     given_name: NA</span></span>
<span><span class="co">#&gt;     super:  &lt;ggproto object: Class Person, gg&gt;</span></span></code></pre></div><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>El resultado que se muestra arriba ilustra que <code>NewSubClass</code> ahora proporciona su propia clase y que hereda todos los campos y métodos del objeto <code>Persona</code> que creamos anteriormente. Sin embargo, esta nueva subclase no agrega ninguna funcionalidad nueva.</p>
<p>Al crear una subclase, a menudo queremos agregar nuevos campos o métodos y sobrescribir algunos de los existentes. Por ejemplo, supongamos que queremos definir <code>Royalty</code> como una subclase de <code>Person</code> y agregar campos correspondientes al <code>rank</code> de la realeza en cuestión y el <code>territory</code> sobre el que gobernaban. Debido a que a menudo se hace referencia a la realeza por título y territorio en lugar de en términos de nombre y apellido, también necesitaremos cambiar la forma en que se define el método <code>full_name()</code>:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb26"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">Royalty</span> <span class="op">&lt;-</span> <span class="fu">ggproto</span><span class="op">(</span><span class="st">"Royalty"</span>, <span class="va">Person</span>,</span>
<span>  rank <span class="op">=</span> <span class="cn">NA</span>,</span>
<span>  territory <span class="op">=</span> <span class="cn">NA</span>,</span>
<span>  full_name <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">self</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="va">self</span><span class="op">$</span><span class="va">rank</span>, <span class="va">self</span><span class="op">$</span><span class="va">given_name</span>, <span class="st">"of"</span>, <span class="va">self</span><span class="op">$</span><span class="va">territory</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">)</span></span></code></pre></div><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>El objeto <code>Royalty</code> ahora define una subclase de persona que hereda algunos campos (<code>given_name</code>, <code>family_name</code>, <code>birth_date</code>) de la clase <code>Person</code> y proporciona otros campos (<code>rank</code>, <code>territory</code>). Hereda los métodos <code>age()</code> y <code>description()</code> de <code>Person</code>, pero sobrescribe el método <code>full_name()</code>.</p>
<p>Ahora podemos crear una nueva instancia de la subclase <code>Royalty</code>:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb27"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">Victoria</span> <span class="op">&lt;-</span> <span class="fu">ggproto</span><span class="op">(</span><span class="cn">NULL</span>, <span class="va">Royalty</span>,</span>
<span>  given_name <span class="op">=</span> <span class="st">"Victoria"</span>,</span>
<span>  family_name <span class="op">=</span> <span class="st">"Hanover"</span>,</span>
<span>  rank <span class="op">=</span> <span class="st">"Queen"</span>,</span>
<span>  territory <span class="op">=</span> <span class="st">"the United Kingdom"</span>,</span>
<span>  birth_date <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op">(</span><span class="st">"1819/05/24"</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Entonces, cuando llamamos al método <code>full_name()</code> para <code>Victoria</code>, la salida usa el método especificado en la clase <code>Royalty</code> en lugar del definido en la clase <code>Persona</code>:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb28"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">Victoria</span><span class="op">$</span><span class="fu">full_name</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "Queen Victoria of the United Kingdom"</span></span></code></pre></div><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Vale la pena señalar lo que sucede cuando llamamos al método <code>description()</code>. Este método se hereda de <code>Person</code>, pero la definición de este método invoca <code>self$full_name()</code>. Aunque <code>description()</code> está definida en <code>Person</code>, en este contexto <code>self</code> todavía se refiere a <code>Victoria</code>, que sigue siendo <code>Royalty</code>. Lo que esto significa es que la salida del método heredado <code>description()</code> utiliza el método <code>full_name()</code> definido para la subclase:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb29"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">Victoria</span><span class="op">$</span><span class="fu">description</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "Queen Victoria of the United Kingdom is 206 years old"</span></span></code></pre></div><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>La creación de subclases a veces requiere que accedamos a la clase principal y sus métodos, lo que podemos hacer con la ayuda de la función <code>ggproto_parent()</code>. Por ejemplo, podemos definir una subclase <code>Police</code> que incluya un campo <code>rank</code> de la misma manera que lo hace la subclase <code>Royalty</code>, pero solo usa este rango como parte del método <code>description()</code>:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb30"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">Police</span> <span class="op">&lt;-</span> <span class="fu">ggproto</span><span class="op">(</span><span class="st">"Police"</span>, <span class="va">Person</span>,</span>
<span>  rank <span class="op">=</span> <span class="cn">NA</span>, </span>
<span>  description <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">self</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span></span>
<span>      <span class="va">self</span><span class="op">$</span><span class="va">rank</span>,</span>
<span>      <span class="fu">ggproto_parent</span><span class="op">(</span><span class="va">Person</span>, <span class="va">self</span><span class="op">)</span><span class="op">$</span><span class="fu">description</span><span class="op">(</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">)</span></span></code></pre></div><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>En este ejemplo, el método <code>description()</code> para la subclase <code>Police</code> se define de una manera que se refiere explícitamente al método <code>description()</code> para la clase principal <code>Person</code>. Al usar <code>ggproto_parent(Person, self)</code> de esta manera, podemos hacer referencia al método dentro de la clase principal, manteniendo la definición local apropiada de <code>self</code>. Como antes, crearemos una instancia específica y verificaremos que funcione como se esperaba:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb31"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">John</span> <span class="op">&lt;-</span> <span class="fu">ggproto</span><span class="op">(</span><span class="cn">NULL</span>, <span class="va">Police</span>,</span>
<span>  given_name <span class="op">=</span> <span class="st">"John"</span>,</span>
<span>  family_name <span class="op">=</span> <span class="st">"McClane"</span>,</span>
<span>  rank <span class="op">=</span> <span class="st">"Detective"</span>,</span>
<span>  birth_date <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op">(</span><span class="st">"1955/03/19"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">John</span><span class="op">$</span><span class="fu">full_name</span><span class="op">(</span><span class="op">)</span> </span>
<span><span class="co">#&gt; [1] "John McClane"</span></span>
<span></span>
<span><span class="va">John</span><span class="op">$</span><span class="fu">description</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "Detective John McClane is 70 years old"</span></span></code></pre></div><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Por razones que discutiremos a continuación, el uso de <code>ggproto_parent()</code> no es tan frecuente en el código fuente de ggplot2.</p>
</section><section id="sec-ggproto-style" class="level3" data-number="19.4.5"><h3 data-number="19.4.5" class="anchored" data-anchor-id="sec-ggproto-style">
<span class="header-section-number">19.4.5</span> Guía de estilo para ggproto</h3>
<p>Debido a que ggproto es un sistema de clases mínimo diseñado para acomodar ggplot2 y nada más, es importante reconocer que ggproto se usa en ggplot2 de una manera muy específica. Existe para admitir el sistema de extensión ggplot2 y es poco probable que encuentre ggproto en cualquier otro contexto que no sea escribir la extensión ggplot2. Teniendo esto en cuenta, es útil comprender cómo ggplot2 usa ggproto:</p>
<ul>
<li><p><strong>las clases ggproto se usan selectivamente</strong>. El uso de ggproto en ggplot2 no lo abarca todo. Solo la funcionalidad seleccionada se basa en ggproto y no se espera ni se recomienda crear clases de ggproto completamente nuevas en sus extensiones. Como desarrollador de extensiones, nunca creará objetos ggproto completos, sino que creará una subclase de una de las clases principales de ggproto proporcionadas por ggplot2. <a href="extensions.html" class="quarto-xref"><span>Capítulo 20</span></a> y <a href="ext-springs.html" class="quarto-xref"><span>Capítulo 21</span></a> detallarán cómo hacer esto.</p></li>
<li><p><strong>las clases ggproto no tienen estado</strong>. Excepto por unas pocas clases internas que se utilizan para orquestar la representación, se supone que las clases ggproto en ggplot2 son “sin estado”. Lo que esto significa es que ggplot2 espera que una vez construidos, no cambien. Esto rompe una expectativa común para las clases basadas en referencias (donde los métodos a menudo pueden cambiar de forma segura el estado del objeto), pero no es seguro hacerlo con ggplot2. Si su código viola este principio y cambia el estado de una Stat o Geom durante el renderizado, trazar un objeto ggplot guardado afectará <em>todas</em> las instancias de esa Stat o Geom (incluso aquellas utilizadas en otros gráficos) porque todas apuntan al mismo objeto padre ggproto. Teniendo esto en cuenta, sólo hay dos ocasiones en las que debes especificar el estado de un objeto ggproto en ggplot2. Primero, puede especificar el estado al crear el objeto: esto está bien porque este estado debe compartirse entre todas las instancias de todos modos. En segundo lugar, puede especificar el estado mediante un objeto de parámetros administrado en otro lugar. Como verá más adelante (ver <a href="extensions.html#sec-new-stats" class="quarto-xref"><span>Sección 20.2</span></a> y <a href="extensions.html#sec-new-geoms" class="quarto-xref"><span>Sección 20.3</span></a>), la mayoría de las clases de ggproto tienen un método <code>setup_params()</code> donde se pueden inspeccionar datos y calcular y almacenar propiedades específicas.</p></li>
<li>
<p><strong>las clases ggproto tienen herencia simple</strong>. Debido a que las instancias de la clase ggproto no tienen estado, es relativamente seguro llamar a métodos definidos dentro de otras clases, en lugar de heredar explícitamente de la clase. Esta es la razón por la cual la función <code>ggproto_parent()</code> rara vez se llama dentro del código fuente de ggplot2. Como ejemplo, el método <code>setup_params()</code> en <code>GeomErrorbar</code> se define como:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb32"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">GeomErrorbar</span> <span class="op">&lt;-</span> <span class="fu">ggproto</span><span class="op">(</span></span>
<span>  <span class="co"># ...</span></span>
<span>  setup_params <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">data</span>, <span class="va">params</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">GeomLinerange</span><span class="op">$</span><span class="fu">setup_params</span><span class="op">(</span><span class="va">data</span>, <span class="va">params</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="co"># ...</span></span>
<span><span class="op">)</span></span></code></pre></div><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Este patrón suele ser más fácil de leer que usar <code>ggproto_parent()</code> y como los objetos ggproto no tienen estado, es igual de seguro.</p>
</li>
</ul>


<div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list">
<div id="ref-R6" class="csl-entry" role="listitem">
Chang, Winston. 2020. <em>R6: Encapsulated Classes with Reference Semantics</em>. <a href="https://CRAN.R-project.org/package=R6">https://CRAN.R-project.org/package=R6</a>.
</div>
<div id="ref-proto" class="csl-entry" role="listitem">
Grothendieck, Gabor, Louis Kates, y Thomas Petzoldt. 2016. <em>proto: Prototype Object-Based Programming</em>. <a href="https://CRAN.R-project.org/package=proto">https://CRAN.R-project.org/package=proto</a>.
</div>
</div>
</section></section><section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes"><hr>
<ol>
<li id="fn1"><p>Por lo general, no se llama a este método <code><a href="https://rdrr.io/r/graphics/plot.default.html">plot()</a></code> directamente, ya que lo invoca el método print y, por lo tanto, se llama cada vez que se imprime un objeto ggplot.<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2"><p>Es posible que una estadística evite esta división sobrescribiendo métodos <code>compute_*()</code> específicos y así realizar cierta optimización.<a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol></section></main><!-- /main --><script>

  // Chapter name
  const currentChapterFile = window.location.pathname.split('/').pop().replace('.html', '');

  //Defining urls
  const originalURL = "https://github.com/hadley/ggplot2-book";
  const translationURL = "https://github.com/davidrsch/ggplot2b-es";

  //Defining texts
  const edit_text = "Editar esta página";
  const issue_text = "Informar de un problema"

  //Defining git_i
  const git_i = '<div><i class="bi bi-github"></i></div>';

  // Adding TOC if not exist
  const sidebarmargin = document.getElementById('quarto-margin-sidebar');
  const buscar_TOC = document.getElementById('TOC');

  if (!buscar_TOC) {
    const crear_TOC = document.createElement('nav');
    crear_TOC.id = 'TOC';
    crear_TOC.role = "doc-toc";
    crear_TOC.class = "toc-active";
    sidebarmargin.appendChild(crear_TOC);
  }


  // Adding original github actions
  const TOC = document.getElementById('TOC');
  const originalga = document.createElement('h2');
  originalga.textContent = "Original";
  originalga.style["border-top"] = "1px solid #ccc";
  originalga.style["padding-top"] = "0.5rem";
  const toc_act_O = document.createElement('div');
  toc_act_O.className = 'toc-actions';
  toc_act_O.id = 'toc-act-O';
  const act_link_O = document.createElement('div');
  act_link_O.className='action-links';
  act_link_O.id='act-link-O';
  const edit_issue_O ='<p><a href="'+originalURL+'/edit/master/'+currentChapterFile+'.qmd" class="toc-action">'+edit_text+'</p><p><a href="'+originalURL+'/issues/new" class="toc-action">'+issue_text+'</p>';


  TOC.appendChild(originalga);
  TOC.appendChild(toc_act_O);
  toc_act_O.innerHTML += git_i;
  toc_act_O.appendChild(act_link_O);
  act_link_O.innerHTML += edit_issue_O;

  // Adding translation github actions
  const translationga = document.createElement('h2');
  translationga.textContent = "Traducción";
  const toc_act_T = document.createElement('div');
  toc_act_T.className = 'toc-actions';
  toc_act_T.id = 'toc-act-T';
  const act_link_T = document.createElement('div');
  act_link_T.className='action-links';
  act_link_T.id='act-link-T';
  const edit_issue_T ='<p><a href="'+translationURL+'/edit/main/'+currentChapterFile+'.qmd" class="toc-action">'+edit_text+'</p><p><a href="'+translationURL+'/issues/new" class="toc-action">'+issue_text+'</p>';


  TOC.appendChild(translationga);
  TOC.appendChild(toc_act_T);
  toc_act_T.innerHTML += git_i;
  toc_act_T.appendChild(act_link_T);
  act_link_T.innerHTML += edit_issue_T;


</script><script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copiado");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copiado");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script><nav class="page-navigation"><div class="nav-page nav-page-previous">
      <a href="./programming.html" class="pagination-link" aria-label="Programar con ggplot2">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">18</span>&nbsp; <span class="chapter-title">Programar con ggplot2</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./extensions.html" class="pagination-link" aria-label="Extendiendo ggplot2">
        <span class="nav-page-text"><span class="chapter-number">20</span>&nbsp; <span class="chapter-title">Extendiendo ggplot2</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->
<footer class="footer"><div class="nav-footer">
    <div class="nav-footer-left">
<p>ggplot2: Gráficos elegantes para análisis de datos (3e) fue escrito por Hadley Wickham, Danielle Navarro, y Thomas Lin Pedersen.</p>
</div>   
    <div class="nav-footer-center">
      &nbsp;
    </div>
    <div class="nav-footer-right">
<p>Este libro fue creado usando <a href="https://quarto.org/">Quarto</a>.</p>
</div>
  </div>
</footer>


</body></html>